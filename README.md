# fedi_findandkillspam (Yunochi 커스텀)

## 사용법
1. 설정을 합니다
    - **config.json**을 열고 값을 수정합니다
    ```jsonc
    {
        "Mastodon": false,  // <-- 마스토돈이라면, true로 설정하세요
        "Misskey": false,   // <-- 미스키라면, true로 설정하세요
        "Misskey_StreamName": "" ,// <-- 미스키의 노트 스트리밍 채널을 변경하려는 경우 설정하세요. (설정하지 않으면 globalTimeline)
        // 미스키에서, 스팸을 올린 사용자를 자동으로 정지할지 정합니다.
        // false일 경우 노트만 삭제하고 사용자를 정지하지는 않습니다.
        // (마스토돈에서는 노트 삭제를 지원하지 않습니다. 그래서 항상 정지합니다.)

        "Misskey_ShouldBanUser": true,
        "badPostTextRegex": [], // <- 스팸 키워드를 정규식으로 설정
        "badPostQrTextRegex": [], // <- 스팸 QR코드의 내용을 정규식으로 설정

        "Site": "https://instancename.example.com/",  // <-- 인스턴스의 주소를 넣으세요
        "ApiKey": "???????"  // <-- API 액세스 토큰을 넣으세요 (아래 설명 참조)
    }
    ```
2. `docker compose build` 를 사용하여 빌드 후, `docker compose up -d` 를 사용하여 컨테이너를 실행합니다. 
3. 로그를 보려면 `docker compose logs` 를 사용합니다. 

### (Misskey) API 액세스 토큰 얻기
- 관리자 권한을 사용하려면, 미스키 API를 통해서 토큰을 발급받아야 합니다.
1. AiScript 스크래치 패드를 엽니다. (/scratchpad)
2. 아래의 AiScript를 실행합니다. 그러면 토큰이 나옵니다.
```
<: "Token is:"
<: Mk:api("miauth/gen-token" {
  session: null,
  name: 'Fedi_FindAndKillSpam',
  description: 'github.com/yunochi/fedi_findandkillspam',
  permission: ['read:account', 'write:notes', 'write:admin:suspend-user'],
}).token
```
3. **제어판의 역할 설정에서, 모더레이터의 `요청 빈도 제한`을 `0%`로 설정해 주세요.**
    - 기본값(100%)에서는, 노트를 1시간에 300개까지만 삭제할 수 있습니다. (유저 정지에는 제한이 없습니다.)

### (Mastodon) API 액세스 토큰 얻기
1. 설정 -> 개발 -> 새로운 애플리케이션
2. *애플리케이션 이름*은 마음대로 설정합니다
3. `read:statuses`와 `admin:write:accounts` 권한을 허용하고 제출합니다.
4. *액세스 토큰*을 얻었습니다.

### 작동방식
- 매 초 글로벌 타임라인을 확인합니다
- 수상한 계정이 수상한 노트를 올린다면, 자동으로 요격합니다
- 서버 단위가 아닌 유저 단위로 작동합니다
    - 서버에서 별도의 설정을 할 필요가 없습니다
    - 네, 원래는 사람 모더레이터가 했을 일을 얘가 대신 한다고 생각하시면 됩니다.
    - 네, **아무 컴퓨터에나 켜놓아도 잘 작동합니다.** 그냥 누군가의 개인 데스크탑이나 노트북에서 켜 놔도, 컴퓨터를 끄지 않는 한 (+절전모드로 들어가지 않는 한) 잘 작동합니다.
        - 물론 운영체제도 상관없습니다. Deno가 돌아가는 한 잘 작동합니다.
        - 위에도 쓰여있듯, 모더레이터가 하는 일을 자동화한 것과 같습니다.
        - 다른 사람 컴퓨터에서 돌리는 것도 가능은 합니다만, API 액세스 토큰 유출에 주의하셔야 합니다. 신뢰할 수 있는 경우 그렇게 하셔도 됩니다.

### 비고
**Rev 3부터 제대로 작동합니다.** 그 전까지는 제대로 테스트를 못 했어요...

**Rev 5부터 자동 업데이트를 지원합니다.** 켜두기만 하면 서버에서 최신 스크립트를 자동으로 받아와서 실행합니다. (다만, 보안상 신경쓰이는 부분이 있다면 로컬로 실행하는 것이 나을 수도 있습니다.)

**Rev 7부터 미스키에서도 웹소켓을 사용합니다.** 처리 누락되는 노트가 줄어들고 반응시간이 빨라질 것으로 예상합니다.

**Rev 9에서 탐지를 빠져나가는 몇 가지 경우를 수정했습니다.**

**유놋치 커스텀: 포크해서 제가 쓸 기능들 추가하고 이것저것 암튼 함** 므아... 수정 후에 미스키에서만 일단 테스트 되었습니다. 